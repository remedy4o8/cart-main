<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remedy's Magic Shopping Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body { background-color: #000; }
        #notification {
            position: fixed; top: 20px; right: 20px; background-color: #d291bc; color: #fff; padding: 10px;
            border-radius: 10px; opacity: 0; transition: opacity 0.5s, background-color 0.5s; z-index: 1000; font-size: 16px;
        }
        .notification-red { background-color: #e3342f; color: #ffffff; }
        .notification-purple { background-color: #d291bc; color: #ffffff; }
        .fa-cart-plus, .fa-trash-alt { margin-right: 10px; }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto p-4">
        <div class="flex flex-wrap">
            <div class="w-full md:w-2/3">
                <h1 class="text-3xl mb-4 text-teal-400">Let the Shopping Begin!</h1>
                <p class="mb-4">Welcome to your go-to spot for snagging the latest Little Sleepies! Whether we get a sneak peek of the products early or right on time, you’ll find them here. No need to refresh multiple pages—just start here about 15-30 seconds before 8:55AM PST or 11:55AM EST to catch all the cuteness in one place.</p>
                <p class="mb-4">Pick your favorites, select the perfect sizes, and pop them into your cart. When you’re ready, hit 'View Cart' to zip over to the store's website where your chosen items are waiting to be yours.</p>
                <p class="mb-4">P.S. Blankets are so snuggly and popular, we’ve gone ahead and tucked two into your cart to start. Happy shopping, Mom’s!</p>
                <div id="products" class="flex flex-wrap justify-start items-stretch gap-4"></div>
            </div>
            <div class="w-full md:w-1/3 sticky top-0" style="height: calc(100vh - 1rem);">
                <div class="overflow-y-auto p-4">
                    <h2 class="text-2xl mb-4 text-lime-300">Shopping Cart</h2>
                    <ul id="cartItems" class="space-y-2"></ul>
                    <button id="cartUrl" class="mt-4 bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded hidden">View Cart</button>
                    <button id="clearCart" class="mt-4 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Clear Cart</button>
                    <p id="cartUrlDisplay" class="mt-2 text-sm hidden"></p>
                </div>
            </div>
        </div>
    </div>
    <div id="notification"><i class="fas fa-info-circle"></i> <span id="notificationText"></span></div>
    <script>
        const shopUrl = "https://littlesleepies.com";
        let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
        let currentPage = 1;
        const maxPages = 3; // Only fetch up to 3 pages

        async function fetchProducts() {
            if (currentPage > maxPages) {
                console.log('Reached maximum page limit.');
                return; // Stop fetching when the maximum page count is reached
            }

            const url = `https://littlesleepies.com/collections/vip-early-access/products.json?page=${currentPage}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (data.products && data.products.length > 0) {
                    // Sort products before displaying them
                    data.products.sort((a, b) => {
                        const keyPhrases = ["cloud blanket", "zippy"];
                        const aScore = scoreProduct(a.title, keyPhrases);
                        const bScore = scoreProduct(b.title, keyPhrases);
                        return aScore - bScore;
                    });
                    
                    displayProducts(data);
                    autoAddBlankets(data.products);
                    currentPage++; // Increment the page number
                    fetchProducts(); // Recursively fetch the next page
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('products').innerHTML = `<div class="text-red-500 p-4">Error fetching products: ${error.message}</div>`;
            }
        }

        function scoreProduct(title, keyPhrases) {
            return keyPhrases.reduce((acc, phrase) => {
                return title.toLowerCase().includes(phrase) ? Math.min(acc, keyPhrases.indexOf(phrase)) : acc;
            }, keyPhrases.length);
        }

        function displayProducts(data) {
            const container = document.getElementById('products');
            if (!data.products || data.products.length === 0) {
                container.innerHTML = '<div class="p-4">No Products Found.</div>';
                return;
            }

            data.products.forEach(product => {
                const productElement = document.createElement('div');
                productElement.className = 'w-full sm:w-1/2 md:w-1/4 p-4';
                const firstImageSrc = product.images[0] ? product.images[0].src : 'placeholder.jpg';
                productElement.innerHTML = `
                    <div class="bg-gray-800 rounded overflow-hidden shadow-lg">
                        <img class="w-full h-48 object-cover" src="${firstImageSrc}" alt="${product.title}" loading="lazy">
                        <div class="p-4">
                            <div class="font-bold text-xl mb-2">${product.title} $${product.variants[0].price}</div>
                            <div class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>`;
                const variantsGrid = productElement.querySelector('.flex-wrap');
                product.variants.forEach(variant => {
                    const variantButton = document.createElement('button');
                    variantButton.className = 'bg-pink-500 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded';
                    variantButton.textContent = `${variant.option1}`;
                    variantButton.setAttribute('aria-label', `Add ${product.title}, Size ${variant.option1} to cart`);
                    variantButton.onclick = () => addVariantToCart(product.title, variant.id, variant.option1, variant.option2, firstImageSrc);
                    variantsGrid.appendChild(variantButton);
                });
                container.appendChild(productElement);
            });
        }

        function autoAddBlankets(products) {
            products.forEach(product => {
                const titleLower = product.title.toLowerCase();
                if (titleLower.includes("blanket") && titleLower.includes("cloud") && titleLower.includes("simba")) {
                    const cloudBlanketCount = countProductInCart("simba cloud blanket");
                    const numberToAdd = 2 - cloudBlanketCount; // Ensure we add up to two
                    for (let i = 0; i < numberToAdd; i++) {
                        addVariantToCart(product.title, product.variants[0].id, product.variants[0].option1, product.variants[0].option2, product.images[0].src);
                    }
                }
            });
        }

        function addVariantToCart(title, variantId, size, color, imageUrl) {
            cartItems.push({ title, variantId, size, color, imageUrl });
            localStorage.setItem('cartItems', JSON.stringify(cartItems)); // Save to local storage
            updateCartList();
            displayNotification('Added', `Added to cart: ${title}`, 'purple');
        }

        function clearCart() {
            cartItems = [];
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            updateCartList();
            displayNotification('Cleared', 'All items have been removed from the cart.', 'red');
        }

        function updateCartList() {
            const cartList = document.getElementById('cartItems');
            cartList.innerHTML = cartItems.map((item, index) => `
                <li class="bg-gray-800 p-2 rounded flex justify-between items-center">
                    <div class="flex items-center">
                        <img src="${item.imageUrl}" class="w-10 h-10 rounded-full" alt="Product" loading="lazy">
                        <div class="ml-4">
                            <p class="text-sm font-medium">${item.title}</p>
                            <p class="text-xs text-gray-400">Size: ${item.size}, Color: ${item.color}</p>
                        </div>
                    </div>
                    <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded" aria-label="Remove ${item.title} from cart" onclick="removeItemFromCart(${index})">Remove</button>
                </li>`).join('');
            toggleCartVisibility();
        }

        function removeItemFromCart(index) {
            cartItems.splice(index, 1);
            localStorage.setItem('cartItems', JSON.stringify(cartItems)); // Update local storage
            updateCartList();
            displayNotification('Removed', 'Item removed from cart.', 'red');
        }

        function toggleCartVisibility() {
            const cartLink = document.getElementById('cartUrl');
            const cartUrlDisplay = document.getElementById('cartUrlDisplay');
            if (cartItems.length > 0) {
                cartLink.classList.remove('hidden');
                cartUrlDisplay.classList.remove('hidden');
                const encodedItems = cartItems.map(item => `${item.variantId}:1`).join(',');
                const cartUrl = `${shopUrl}/cart/${encodedItems}?discount=lsvip`; // Appending discount code
                cartLink.onclick = () => window.open(cartUrl, '_blank');
            } else {
                cartLink.classList.add('hidden');
                cartUrlDisplay.classList.add('hidden');
            }
        }

        function displayNotification(action, message, color) {
            const notificationElement = document.getElementById('notification');
            notificationElement.style.opacity = 1;
            document.getElementById('notificationText').innerText = message;
            if (color === 'red') {
                notificationElement.classList.add('notification-red');
                notificationElement.classList.remove('notification-purple');
            } else {
                notificationElement.classList.add('notification-purple');
                notificationElement.classList.remove('notification-red');
            }
            setTimeout(() => notificationElement.style.opacity = 0, 2500);
        }

        function countProductInCart(identifier) {
            return cartItems.reduce((count, item) => item.title.includes(identifier) ? count + 1 : count, 0);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
            loadCartFromLocalStorage();
            document.getElementById('clearCart').addEventListener('click', clearCart);
        });

        function loadCartFromLocalStorage() {
            const storedCart = localStorage.getItem('cartItems');
            if (storedCart) {
                cartItems = JSON.parse(storedCart);
                updateCartList();
            }
        }
    </script>
</body>
</html>
