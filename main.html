<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Enhanced Shopping Cart</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css">
<style>
    body {
        background-color: #363636; /* Dark background for better contrast */
    }
    .image img {
        height: 100%; /* Ensure images cover their frame */
        width: auto;
        object-fit: cover;
    }
</style>
</head>
<body>
<div class="container">
    <div class="columns">
        <div class="column is-two-thirds">
            <h1 class="title has-text-white">Welcome to Andy's Secret Shopping Cart</h1>
            <div id="products" class="columns is-multiline"></div>
        </div>
        <div class="column is-one-third">
            <div class="sticky" style="top: 20px; overflow-y: auto; max-height: calc(100vh - 20px);">
                <h2 class="subtitle has-text-white">Shopping Cart</h2>
                <ul id="cartItems"></ul>
                <button id="cartUrl" class="button is-success is-fullwidth mt-4">View Cart</button>
                <p class="has-text-white mt-4" id="cartUrlDisplay"></p>
            </div>
        </div>
    </div>
</div>

<script>
    const shopUrl = "https://www.100percentpure.com";

    async function fetchProducts(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const data = await response.json();
            displayProducts(data);
        } catch (error) {
            console.error('Error fetching data:', error);
            document.getElementById('products').innerHTML = `<div class="notification is-danger">Error fetching products: ${error.message}</div>`;
        }
    }

    function displayProducts(data) {
        const container = document.getElementById('products');
        if (!data.products || data.products.length === 0) {
            container.innerHTML = '<div class="notification is-warning">No products found.</div>';
            return;
        }

        data.products.forEach(product => {
            const productElement = document.createElement('div');
            productElement.className = 'column is-one-quarter';
            const firstImageSrc = product.images[0] ? product.images[0].src : 'placeholder.jpg';
            productElement.innerHTML = `
                <div class="card">
                    <div class="card-image">
                        <figure class="image is-4by3">
                            <img src="${firstImageSrc}" alt="Image of ${product.title}">
                        </figure>
                    </div>
                    <div class="card-content">
                        <p class="title is-4">${product.title} $${product.variants[0].price}</p>
                        <div class="buttons">`;
            product.variants.forEach(variant => {
                productElement.innerHTML += `
                        <button class="button is-small is-primary" onclick="addVariantToCart('${product.title}', '${variant.id}', '${variant.option1}', '${variant.option2}', '${firstImageSrc}')">
                            ${variant.option1}
                        </button>`;
            });
            productElement.innerHTML += `</div></div></div>`;
            container.appendChild(productElement);
        });
    }

    let cartItems = [];
    function addVariantToCart(title, variantId, size, color, imageUrl) {
        const item = { title, variantId, size, color, imageUrl };
        cartItems.push(item);
        updateCartList();
        updateCartUrl();
    }

    function updateCartList() {
        const cartList = document.getElementById('cartItems');
        cartList.innerHTML = '';
        cartItems.forEach((item, index) => {
            const listItem = document.createElement('li');
            listItem.className = 'box';
            listItem.innerHTML = `
                <article class="media">
                    <div class="media-left">
                        <figure class="image is-64x64">
                            <img src="${item.imageUrl}" alt="Product Image">
                        </figure>
                    </div>
                    <div class="media-content">
                        <div class="content">
                            <p>
                                <strong>${item.title}</strong> <br>
                                Size: ${item.size} <br>
                                Color: ${item.color}
                            </p>
                        </div>
                    </div>
                    <div class="media-right">
                        <button class="delete" onclick="removeItemFromCart(${index})"></button>
                    </div>
                </article>`;
            cartList.appendChild(listItem);
        });
    }

    function updateCartUrl() {
        const encodedItems = cartItems.map(item => encodeURIComponent(`${item.variantId}:1`)).join(',');
        let cartUrl = `${shopUrl}/cart/${encodedItems}`;
        if (shopUrl.includes("littlesleepies.com")) {
            cartUrl += "?discount=LSVIP";
        }
        const cartLink = document.getElementById('cartUrl');
        cartLink.onclick = () => window.open(cartUrl, '_blank');
        document.getElementById('cartUrlDisplay').innerText = cartUrl;
    }

    fetchProducts('https://www.100percentpure.com/collections/new/products.json');
</script>
</body>
</html>
