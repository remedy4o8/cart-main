<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Remedy's Magic Shopping Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    body {
      background-color: #1a1a2e;
      font-family: 'Arial', 'sans-serif';
    }

    #notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #f8bbd0;
      color: #fff;
      padding: 10px;
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.5s, background-color 0.5s;
      z-index: 1000;
      font-size: 16px;
    }

    .notification-red {
      background-color: #e3342f;
      color: #ffffff;
    }

    .notification-purple {
      background-color: #d291bc;
      color: #ffffff;
    }

    .fa-cart-plus,
    .fa-trash-alt {
      margin-right: 10px;
    }

    .rounded-lg {
      border-radius: 1rem;
    }

    .shadow-pink {
      box-shadow: 0 4px 6px rgba(240, 98, 146, 0.3);
    }

    .shadow-pink-dark {
      box-shadow: 0 4px 6px rgba(240, 98, 146, 0.5);
    }
  </style>
</head>

<body class="text-gray-200">
  <div class="container mx-auto p-4">
    <div class="flex flex-wrap">
      <div class="w-full md:w-2/3">
        <h1 class="text-3xl mb-4 text-pink-400">Let the Shopping Begin!</h1>
        <p class="mb-4">Welcome to your go-to spot for snagging the latest Little Sleepies! Whether we get a sneak peek of the products early or right on time, you’ll find them here. No need to refresh multiple pages—start here about 15-30 seconds before 8:55 AM PST or 11:55 AM EST to catch all the cuteness in one place.</p>
        <p class="mb-4">Pick your favorites, select the perfect sizes, and pop them into your cart. When you’re ready, hit 'View Cart' to zip over to the store's website, where your chosen items are waiting to be yours.</p>
        <p class="mb-4">P.S. Blankets are so snuggly and popular that we’ve gone ahead and tucked two into your cart to start. Happy shopping, Mom’s!</p>
        <div id="products" class="flex flex-wrap justify-start items-stretch gap-4"></div>
      </div>
      <div class="w-full md:w-1/3 sticky top-0" style="height: calc(100vh - 1rem);">
        <div class="overflow-y-auto p-4 rounded-lg bg-gray-800 shadow-pink">
          <h2 class="text-2xl mb-4 text-pink-400">Shopping Cart</h2>
          <ul id="cartItems" class="space-y-2"></ul>
          <div class="mt-4">
            <input type="checkbox" id="autoCheckout" class="mr-2">
            <label for="autoCheckout" class="text-pink-500">Auto Checkout Two Cloud Blankets Only</label>
          </div>
          <button id="cartUrl" class="mt-4 bg-pink-500 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded hidden">View Cart</button>
          <button id="clearCart" class="mt-4 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Clear Cart</button>
          <p id="cartUrlDisplay" class="mt-2 text-sm hidden"></p>
        </div>
      </div>
    </div>
  </div>
  <div id="notification">
    <i class="fas fa-info-circle"></i>
    <span id="notificationText"></span>
  </div>
  <script>
    const shopUrl = "https://littlesleepies.com";
    let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
    let currentPage = 1;
    const maxPages = 5; // Only fetch up to 5 pages

    async function fetchProducts() {
      console.log(`Fetching products from page ${currentPage}`);
      if (currentPage > maxPages) {
        console.log('Reached maximum page limit.');
        return; // Stop fetching when the maximum page count is reached
      }
      const url = `https://littlesleepies.com/collections/vip-early-access/products.json?page=${currentPage}`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        console.log(`Fetched data: ${JSON.stringify(data)}`);
        if (data.products && data.products.length > 0) {
          console.log(`Fetched ${data.products.length} products`);
          displayProducts(data);
          autoAddBlankets(data);
          currentPage++; // Increment the page number
          fetchProducts(); // Recursively fetch the next page
        }
      } catch (error) {
        console.error('Error fetching data:', error);
        document.getElementById('products').innerHTML = `
          <div class="text-red-500 p-4">Error fetching products: ${error.message}</div>`;
      }
    }

    function displayProducts(data) {
      console.log('Displaying products');
      const container = document.getElementById('products');
      if (!data.products || data.products.length === 0) {
        container.innerHTML = '<div class="p-4">No Products Found.</div>';
        return;
      }
      data.products.sort((a, b) => {
        const keyPhrases = ["cloud blanket", "two-piece short sleeve", "zippy"];
        const aScore = scoreProduct(a.title, keyPhrases);
        const bScore = scoreProduct(b.title, keyPhrases);
        return aScore - bScore;
      });
      data.products.forEach(product => {
        console.log(`Displaying product: ${product.title}`);
        const productElement = document.createElement('div');
        productElement.className = 'w-full sm:w-1/2 md:w-1/4 p-4';
        const firstImageSrc = product.images[0] ? product.images[0].src : 'placeholder.jpg';
        productElement.innerHTML = `
          <div class="bg-gray-700 rounded-lg overflow-hidden shadow-pink-dark">
            <img class="w-full h-48 object-cover" src="${firstImageSrc}" alt="${product.title}" loading="lazy">
            <div class="p-4">
              <div class="font-bold text-xl mb-2 text-pink-400">${product.title} $${product.variants[0].price}</div>
              <div class="flex flex-wrap gap-2"></div>
            </div>
          </div>`;
        const variantsGrid = productElement.querySelector('.flex-wrap');
        product.variants.forEach(variant => {
          const variantButton = document.createElement('button');
          variantButton.className = 'bg-pink-500 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded';
          variantButton.textContent = `${variant.option1}`;
          variantButton.setAttribute('aria-label', `Add ${product.title}, Size ${variant.option1} to cart`);
          variantButton.onclick = () => addVariantToCart(product.title, variant.id, variant.option1, variant.option2, firstImageSrc);
          variantsGrid.appendChild(variantButton);
        });
        container.appendChild(productElement);
      });
    }

    function autoAddBlankets(data) {
      console.log('Auto-adding blankets');
      data.products.forEach(product => {
        const titleLower = product.title.toLowerCase();
        if (containsAllKeywords(titleLower, ["cloud", "blanket"])) {
          const cloudBlanketCount = countProductInCart("cloud blanket");
          const numberToAdd = Math.max(0, 2 - cloudBlanketCount); // Ensure we add up to two
          for (let i = 0; i < numberToAdd; i++) {
            if (product.variants && product.variants.length > 0 && product.images && product.images.length > 0) {
              console.log(`Auto-adding blanket: ${product.title}`);
              addVariantToCart(product.title, product.variants[0].id, product.variants[0].option1, product.variants[0].option2, product.images[0].src);
            }
          }
        }
      });
    }

    function containsAllKeywords(text, keywords) {
      console.log(`Checking if "${text}" contains all keywords: ${keywords.join(', ')}`);
      return keywords.every(keyword => text.includes(keyword));
    }

    function scoreProduct(title, keyPhrases) {
      console.log(`Scoring product: ${title}`);
      return keyPhrases.reduce((acc, phrase, index) => {
        return title.toLowerCase().includes(phrase) ? Math.min(acc, index) : acc;
      }, keyPhrases.length);
    }

    function addVariantToCart(title, variantId, size, color, imageUrl) {
      console.log(`Adding variant to cart: ${title}, Size: ${size}, Color: ${color}`);
      // Check if the product is a blanket and count how many are already in the cart
      if (title.toLowerCase().includes("cloud blanket")) {
        const blanketCount = countProductInCart("cloud blanket");
        if (blanketCount >= 2) {
          displayNotification('Error', 'You cannot add more than two cloud blankets.', 'red');
          return; // Stop adding if there are already two blankets
        }
      }
      // Add the item if it's not a blanket or if there are fewer than two blankets
      cartItems.push({
        title,
        variantId,
        size,
        color,
        imageUrl
      });
      localStorage.setItem('cartItems', JSON.stringify(cartItems)); // Save to local storage
      updateCartList();
      displayNotification('Added', `Added to cart: ${title}`, 'purple');

      // Check auto-checkout condition
      const autoCheckout = localStorage.getItem('autoCheckout') === 'true';
      const cloudBlanketCount = countProductInCart("cloud blanket");
      if (autoCheckout && cloudBlanketCount >= 2) {
        proceedToCheckout();
      }
    }

    function proceedToCheckout() {
      const encodedItems = cartItems.map(item => `${item.variantId}:1`).join(',');
      const cartUrl = `${shopUrl}/cart/${encodedItems}?discount=lsvip`;
      window.open(cartUrl, '_blank');
      // Clear the cart to prevent double checkout
      cartItems = [];
      localStorage.setItem('cartItems', JSON.stringify(cartItems));
      updateCartList();
    }

    function removeItemFromCart(index) {
      console.log(`Removing item from cart at index ${index}`);
      cartItems.splice(index, 1);
      localStorage.setItem('cartItems', JSON.stringify(cartItems)); // Update local storage
      updateCartList();
      displayNotification('Removed', 'Item removed from cart.', 'red');
    }

    function countProductInCart(identifier) {
      console.log(`Counting products in cart with identifier: ${identifier}`);
      return cartItems.reduce((count, item) => item.title.toLowerCase().includes(identifier.toLowerCase()) ? count + 1 : count, 0);
    }

    function clearCart() {
      console.log('Clearing cart');
      cartItems = [];
      localStorage.setItem('cartItems', JSON.stringify(cartItems));
      updateCartList();
      displayNotification('Cleared', 'All items have been removed from the cart.', 'red');
    }

    function updateCartList() {
      console.log('Updating cart list');
      const cartList = document.getElementById('cartItems');
      cartList.innerHTML = cartItems.map((item, index) => `
        <li class="bg-gray-700 p-2 rounded-lg flex justify-between items-center shadow-pink-dark">
          <div class="flex items-center">
            <img src="${item.imageUrl}" class="w-10 h-10 rounded-full" alt="Product" loading="lazy">
            <div class="ml-4">
              <p class="text-sm font-medium">${item.title}</p>
              <p class="text-xs text-gray-400">Size: ${item.size}</p>
            </div>
          </div>
          <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded" aria-label="Remove ${item.title} from cart" onclick="removeItemFromCart(${index})">Remove</button>
        </li>`).join('');
      toggleCartVisibility();

      // Check auto-checkout condition on cart update
      const autoCheckout = localStorage.getItem('autoCheckout') === 'true';
      const cloudBlanketCount = countProductInCart("cloud blanket");
      if (autoCheckout && cloudBlanketCount >= 2) {
        proceedToCheckout();
      }
    }

    function toggleCartVisibility() {
      console.log('Toggling cart visibility');
      const cartLink = document.getElementById('cartUrl');
      const cartUrlDisplay = document.getElementById('cartUrlDisplay');
      if (cartItems.length > 0) {
        cartLink.classList.remove('hidden');
        cartUrlDisplay.classList.remove('hidden');
        const encodedItems = cartItems.map(item => `${item.variantId}:1`).join(',');
        const cartUrl = `${shopUrl}/cart/${encodedItems}?discount=lsvip`;
        cartLink.onclick = () => window.open(cartUrl, '_blank');
      } else {
        cartLink.classList.add('hidden');
        cartUrlDisplay.classList.add('hidden');
      }
    }

    function displayNotification(action, message, color) {
      console.log(`Displaying notification: ${message}, Color: ${color}`);
      const notificationElement = document.getElementById('notification');
      notificationElement.style.opacity = 1;
      document.getElementById('notificationText').innerText = message;
      if (color === 'red') {
        notificationElement.classList.add('notification-red');
        notificationElement.classList.remove('notification-purple');
      } else {
        notificationElement.classList.add('notification-purple');
        notificationElement.classList.remove('notification-red');
      }
      setTimeout(() => notificationElement.style.opacity = 0, 2500);
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM content loaded');
      fetchProducts();
      updateCartList(); // Ensure cart items are loaded and displayed on page load
      document.getElementById('clearCart').addEventListener('click', clearCart);

      // Load and apply the auto-checkout checkbox state from localStorage
      const autoCheckout = localStorage.getItem('autoCheckout') === 'true';
      const autoCheckoutCheckbox = document.getElementById('autoCheckout');
      autoCheckoutCheckbox.checked = autoCheckout;
      autoCheckoutCheckbox.addEventListener('change', () => {
        localStorage.setItem('autoCheckout', autoCheckoutCheckbox.checked);
      });
    });

    // Function to refresh the page
    function refreshPage() {
      console.log('Refreshing page');
      location.reload();
    }

    // Calculate the time until 8:55 AM PST
    function timeUntilRefresh() {
      console.log('Calculating time until refresh');
      const now = new Date();
      const targetTime = new Date(now);
      targetTime.setUTCHours(15, 55, 0, 0); // Set target time to 8:55 AM PST (UTC-8)
      // Convert target time to local time
      const userOffset = now.getTimezoneOffset() / 60; // Get user's time zone offset in hours
      targetTime.setHours(targetTime.getHours() - userOffset); // Adjust target time to user's local time
      if (now > targetTime) { // If it's past 8:55 AM PST today, set target time to tomorrow
        targetTime.setDate(targetTime.getDate() + 1);
      }
      return targetTime.getTime() - now.getTime();
    }

    // Schedule the page refresh
    setTimeout(refreshPage, timeUntilRefresh());
  </script>
</body>

</html>
